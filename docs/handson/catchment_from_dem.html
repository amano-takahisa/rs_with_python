

<!DOCTYPE html>
<html class="writer-html5" lang="ja" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DEM(数値標高モデル)からの水系図作成 &mdash; rs-with-python  ドキュメント</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/translations.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="質問・コメント" href="comment_form.html" />
    <link rel="prev" title="OpenCVを利用した葉面積の推定" href="leaf_area_index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> rs-with-python
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../indices/index.html">実験・演習</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../indices/index.html#id2">2年基礎実験</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../indices/index.html#id3">3年専攻演習</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">DEM(数値標高モデル)からの水系図作成</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#QGISを用いた方法">QGISを用いた方法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#PythonからGRASSモジュールを利用する">PythonからGRASSモジュールを利用する</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../indices/index.html#id4">質問・コメント送信</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">rs-with-python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../indices/index.html">実験・演習</a> &raquo;</li>
        
      <li>DEM(数値標高モデル)からの水系図作成</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/handson/catchment_from_dem.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="DEM(数値標高モデル)からの水系図作成">
<h1>DEM(数値標高モデル)からの水系図作成<a class="headerlink" href="#DEM(数値標高モデル)からの水系図作成" title="このヘッドラインへのパーマリンク">¶</a></h1>
<ul>
<li><a href="https://amano-takahisa.github.io/rs_with_python/handson/catchment_from_dem.ipynb">このページのJupyter Notebookファイル</a></li>
<li><a href="https://youtu.be/42k_H4Yl09s">解説動画</a></li>
<li><a href="https://github.com/amano-takahisa/rs_with_python/raw/master/source/handson/data/watershed/dem_fuefuki.tif">利用するデータ</a></li>
</ul><p>ここでは、数値標高モデルのデータから水系図の作成を行います。</p>
<p>以下の2つの方法を説明します。</p>
<ul class="simple">
<li><p>QGISを経由してGRASS GISのモジュールを利用する</p></li>
<li><p>PythonからGRASS GISのモジュールを利用する</p></li>
</ul>
<p>どちらも、<a class="reference external" href="https://grass.osgeo.org/">GRASS GIS</a>の<a class="reference external" href="https://grass.osgeo.org/grass78/manuals/r.watershed.html">r.watershed</a>というモジュールを利用して水系図を作成します。GRASS
GISは独自のデータベース構造を持つため、はじめは仕組みを理解することが難しいかもしれませんが、ラスタデータやベクタデータを扱う多くのライブラリがあり、リモートセンシングやGISの解析に非常に有用なツールです。QGISを経由してGRASSのモジュールを利用することで、比較的簡易にそれらのツールを利用することができるようになります。また、Pythonを使う方法を利用すると、バッチ処理やほかのPython処理とスムーズに結合することができるようになります。</p>
<p>まずはQGISを使った方法を説明します。</p>
<p>事前に、<a class="reference external" href="https://trac.osgeo.org/osgeo4w/">OSGeo4W</a>からネットワークインストーラーをダウンロードして、QGIS Desktop with GRASSが使えるようにしておいてください。インストールの設定は、エクスプレスインストールを選択し、すべてデフォルトの設定で大丈夫です。</p>
<p>データは笛吹川上流域のSRTM DEMデータを利用します。SRTMデータはWGS84の地理座標系で提供されています。事前にUTM座標系に変換したものを準備したので、<a class="reference external" href="data/watershed/dem_fuefuki.tif">ここから</a>ダウンロードしてdataフォルダに保存してください。</p>
<div class="section" id="QGISを用いた方法">
<h2>QGISを用いた方法<a class="headerlink" href="#QGISを用いた方法" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>スタートメニューから、QGISを検索し、<strong>QGIS Desktop with GRASS</strong>を起動してください。<strong>with GRASS表記がないものでは以下は動きません。</strong></p>
<p><img alt="QGISの起動" src="../_images/ss_catchment_01_start_qgis.png" /></p>
<p>ダウンロードした<code class="docutils literal notranslate"><span class="pre">dem_fuefuki.tif</span></code>をQGISにドラッグ＆ドロップしてデータを読み込みます。読み込まれたデータはLayersパネルに一覧が表示されます。Layersパネルが表示されていない場合、View → PanelsメニューからLayersをオンにしてください。また、同じメニューから、Processing Tool Boxのパネルも表示してください。</p>
<video controls src="../_static/mv_watershed_load_dem.mp4"><p>animation</p>
</video><div class="section" id="GRASS-GISモジュールの実行">
<h3>GRASS GISモジュールの実行<a class="headerlink" href="#GRASS-GISモジュールの実行" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Processing Toolboxから、GRASS GISやSAGA GISなどのほかのフリーのGISソフトが提供するツール群を利用することができます。Processing Toolboxの検索ボックスに“water”と入れて表示される“r.watershed”モジュールを起動してください。</p>
<p><img alt="watershedモジュールの起動" src="../_images/ss_watershed_rwatershed.png" /></p>
<p>モジュールに以下の設定を行い、Runを押して実行してください。記載のない項目はすべてデフォルトの値です。</p>
<ul class="simple">
<li><p>Elevation : dem_fuefuki [EPSG:32654]</p></li>
<li><p>Minimum size of exterior watershed basin [optional] : 1000</p></li>
</ul>
<p>上記のオプションで最小面積が<span class="math notranslate nohighlight">\(1000m^2\)</span>となるような集水域図が作成されます。 ログメッセージが表示後、モジュールの実行が完了します。モジュールウィンドウは閉じてください。</p>
</div>
<div class="section" id="結果">
<h3>結果<a class="headerlink" href="#結果" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Layersパネルに計算されたラスターデータが追加されます。</p>
<p>作成されたラスタについて、以下で説明します。図はDEMから作成した陰影図を重ね合わせています。</p>
<div class="section" id="Unique-label-for-each-watershed-basin">
<h4>Unique label for each watershed basin<a class="headerlink" href="#Unique-label-for-each-watershed-basin" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="line-block">
<div class="line">集水域を表します。各集水域に固有のIDが振られています。</div>
<div class="line"><img alt="集水域" src="../_images/watershed_basin.png" /></div>
</div>
</div>
<div class="section" id="Half-basins">
<h4>Half-basins<a class="headerlink" href="#Half-basins" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="line-block">
<div class="line">河川の左右別の集水域を表します。下流から見て右の支流に偶数、左の支流にその1少ない奇数のIDが振られています。</div>
<div class="line"><img alt="半集水域" src="../_images/watershed_basin_half.png" /></div>
</div>
</div>
<div class="section" id="Number-of-cells-that-drain-through-each-cell">
<h4>Number of cells that drain through each cell<a class="headerlink" href="#Number-of-cells-that-drain-through-each-cell" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>各ピクセルより上流にあるピクセルの数を表します。ピクセルサイズと掛け合わせることで、各ピクセルにおける集水域の面積となります。入力DEMの範囲外から流入する地域については値が負になっています。</p>
<p><img alt="ピクセル数" src="../_images/watershed_n_cell.png" /></p>
</div>
<div class="section" id="Stream-segments">
<h4>Stream segments<a class="headerlink" href="#Stream-segments" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>河川の位置を表します。各河川は集水域のIDに対応するID値を持ちます。GRASSの<code class="docutils literal notranslate"><span class="pre">r.to.vect</span></code>モジュールの入力として与えることで、ベクターデータ(shapefile)として出力できます。</p>
<p><img alt="stream" src="../_images/watershed_stream_seg.png" /></p>
</div>
<div class="section" id="Drainage-direction">
<h4>Drainage direction<a class="headerlink" href="#Drainage-direction" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>各ピクセルでの斜面の方位を示しています。方位は以下の図に示す値で定義されています。(<a class="reference external" href="https://idea.isnew.info/how-to-import-arcgis-flow-direction-into-grass-gis.html">参考</a>)</p>
<p><img alt="流下方位" src="../_images/watershed_drainage_direction_map.png" /> <img alt="方位定義" src="../_images/watershed_drainage_direction.png" /></p>
</div>
<div class="section" id="Stream-power-index-a-*-tan(b)">
<h4>Stream power index a * tan(b)<a class="headerlink" href="#Stream-power-index-a-*-tan(b)" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>各地点における水が流下する力を示します。各ピクセルにおける単位等高線あたりの集水面積を<span class="math notranslate nohighlight">\(\alpha\)</span>、各地点での傾斜角度を<span class="math notranslate nohighlight">\(\beta\)</span>としたとき、<span class="math notranslate nohighlight">\(\alpha \times tan(\beta)\)</span>と定義されるStream Power Index(SPI)と呼ばれる指標です。(Moore et al. 1991)</p>
<p><img alt="SPI" src="../_images/watershed_stream_pi.png" /></p>
</div>
<div class="section" id="Topographic-index-ln(a-/-tan(b))">
<h4>Topographic index ln(a / tan(b))<a class="headerlink" href="#Topographic-index-ln(a-/-tan(b))" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>各地点における水が流下する力を示します。SPIの自然対数で定義されます。(Quinn et al. 1991)</p>
<p><img alt="TCI" src="../_images/watershed_topo_indx.png" /></p>
</div>
<div class="section" id="Slope-length-and-steepness-(LS)-factor-for-USLE">
<h4>Slope length and steepness (LS) factor for USLE<a class="headerlink" href="#Slope-length-and-steepness-(LS)-factor-for-USLE" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Revised Universal Soil Loss Equation (RUSLE)におけるLSの値(傾斜長および傾斜度)を示します。</p>
<p><img alt="LS" src="../_images/watershed_slope_ls.png" /></p>
</div>
<div class="section" id="Slope-steepness-(S)-factor-for-USLE">
<h4>Slope steepness (S) factor for USLE<a class="headerlink" href="#Slope-steepness-(S)-factor-for-USLE" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Revised Universal Soil Loss Equation (RUSLE)におけるSの値(傾斜度)を示します。</p>
<p><img alt="S" src="../_images/watershed_slope_s.png" /></p>
</div>
<div class="section" id="結果の保存">
<h4>結果の保存<a class="headerlink" href="#結果の保存" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Layerウィンドウ内でレイヤの右側に<img alt="メモリアイコン" src="../_images/watershed_memory.png" />表示があるレイヤはQGISの一時ファイルに保存されています。GRASSモジュールを実行する際に計算結果の保存先を指定しなかった場合、デフォルトで一時ファイルに保存されます。これらはQGISを終了した際に削除されてしまうので、QGISを閉じる前にGeoTiffファイルとして保存してください。保存方法は、保存したいレイヤを右クリック、Export -&gt; Save as…
で表示されるダイヤログにおいて、フォーマットと保存先フォルダを指定します。その他の設定項目はデフォルト値で大丈夫です。ラスタがファイルに保存され、QGISのレイヤにも追加されます。</p>
<p>以上でQGISを通じたGRASSモジュールによる集水域図を作成することができました。</p>
</div>
</div>
</div>
<div class="section" id="PythonからGRASSモジュールを利用する">
<h2>PythonからGRASSモジュールを利用する<a class="headerlink" href="#PythonからGRASSモジュールを利用する" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>GRASS GISは独自のデータベースを使って計算を行います。Geotiffやシェープファイルなどの一般的なファイルは、初めにGRASSデータベースへ登録する必要があります。</p>
<p>各種の計算は、GRASSデータベースに登録されたデータに対して行われ、計算結果もデータベースに登録されます。</p>
<p>計算の成果物となるラスタデータやベクタデータはこのGRASSデータベース上にあるため、GeotiffやShapefile等の一般的なファイルとしてとりだす作業も必要になります。</p>
<p>上記のQGISを用いたGRASSモジュールの利用では、これらの操作がバックグラウンドで自動で行われます。</p>
<p>GRASS GISはもともとBashターミナルからの操作を想定して設計されたプログラムですが、GRASS GIS 7.8以降ではPythonからの利用が非常にしやすくなりました。</p>
<p>以降では、GRASSが提供するPythonインターフェースを用いて、Jupyter Notebook上でGRASS GISを利用してみます。 <a class="reference external" href="https://grasswiki.osgeo.org/wiki/Working_with_GRASS_without_starting_it_explicitly">参考リンク</a></p>
<p>Windows 10のパソコンから利用する場合、<a class="reference internal" href="setup_ipynb.html"><span class="doc">Jupyter Notebookと環境構築</span></a>を参考にPython環境をセットアップしてください。残念ながら、Google CodelaboratoryではGRASSのバージョンが古いため、以降のコマンドは動きません。</p>
<p>Python環境が設定出来たら、ターミナルから以下のコマンドを実行し、GRASS GISをインストールします。15分ほどかかります。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ubuntuのパスワード入力が必要</span>
sudo apt install grass
</pre></div>
</div>
<p>GRASSのバージョンは7.8以上であることを以下のコマンドで確認してください。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>grass --version
</pre></div>
</div>
<p>Jupyter Notebookからは以下のように確認することもできます。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>grass --version
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
GRASS GIS 7.8.2

Geographic Resources Analysis Support System (GRASS) is Copyright,
1999-2019 by the GRASS Development Team, and licensed under terms of the
GNU General Public License (GPL) version &gt;=2.

This GRASS GIS 7.8.2 release is coordinated and produced by
the GRASS Development Team with contributions from all over the world.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
General Public License for more details.

</pre></div></div>
</div>
<p>また、PythonからGRASS GISを使うために必要な<code class="docutils literal notranslate"><span class="pre">grass-session</span></code>というライブラリをインストールしてください。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install grass-session
</pre></div>
</div>
<p>Jupyter Notebookファイルと同じフォルダに<code class="docutils literal notranslate"><span class="pre">data/watershed/</span></code>フォルダを作成し、解析対象のDEMファイルを保存してください。</p>
<p>まずは必要なライブラリのインポートとパラメータを設定します。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">grass_session</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">grass.script</span> <span class="kn">import</span> <span class="n">core</span> <span class="k">as</span> <span class="n">gcore</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;watershed&#39;</span><span class="p">)</span>
<span class="n">raster_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;dem_fuefuki.tif&#39;</span><span class="p">)</span>
<span class="n">gisdb_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;grass_db&#39;</span><span class="p">)</span>
<span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;fuefuki&#39;</span>
<span class="n">mapset</span> <span class="o">=</span> <span class="s1">&#39;PERMANENT&#39;</span>
</pre></div>
</div>
</div>
<p>GRASSデータベースを作成します。データベースの作成には、扱うGISデータの座標系や空間的な範囲を設定する必要がありますが、これらはdem_fuefuki.tifファイルをもとに作成します。また、データベースの作成と同時にデータベースにdem_fuefuki.tifを登録します。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">gisdb</span><span class="o">=</span><span class="n">gisdb_path</span><span class="p">,</span>
             <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
             <span class="n">mapset</span><span class="o">=</span><span class="n">mapset</span><span class="p">,</span>
             <span class="n">create_opts</span><span class="o">=</span><span class="n">raster_path</span><span class="p">):</span>
    <span class="c1"># import geotiff to PERMANENT mapset and change extent</span>
    <span class="n">gcore</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s1">&#39;r.in.gdal&#39;</span><span class="p">,</span>
                      <span class="n">flags</span><span class="o">=</span><span class="s1">&#39;oe&#39;</span><span class="p">,</span>
                      <span class="nb">input</span><span class="o">=</span><span class="n">raster_path</span><span class="p">,</span>
                      <span class="n">band</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">output</span><span class="o">=</span><span class="s1">&#39;dem&#39;</span><span class="p">,</span>
                      <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>データベースに<code class="docutils literal notranslate"><span class="pre">dem</span></code>という名前で<code class="docutils literal notranslate"><span class="pre">dem_fuefuki.tif</span></code>ファイルが登録されました。</p>
<p>次に、登録された<code class="docutils literal notranslate"><span class="pre">dem</span></code>というラスタデータに対して、GRASSの<code class="docutils literal notranslate"><span class="pre">r.watershed</span></code>モジュールを適用します。</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># create a new location from raster file</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">gisdb</span><span class="o">=</span><span class="n">gisdb_path</span><span class="p">,</span>
             <span class="n">location</span><span class="o">=</span><span class="s1">&#39;fuefuki&#39;</span><span class="p">,</span>
             <span class="n">mapset</span><span class="o">=</span><span class="s1">&#39;PERMANENT&#39;</span><span class="p">):</span>
    <span class="c1"># Run r.watershed command</span>
    <span class="n">gcore</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s1">&#39;r.watershed&#39;</span><span class="p">,</span>
                      <span class="n">elevation</span><span class="o">=</span><span class="s1">&#39;dem&#39;</span><span class="p">,</span>
                      <span class="n">threshold</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                      <span class="n">accumulation</span><span class="o">=</span><span class="s1">&#39;accumulation&#39;</span><span class="p">,</span>
                      <span class="n">drainage</span><span class="o">=</span><span class="s1">&#39;drainage&#39;</span><span class="p">,</span>
                      <span class="n">basin</span><span class="o">=</span><span class="s1">&#39;basin&#39;</span><span class="p">,</span>
                      <span class="n">stream</span><span class="o">=</span><span class="s1">&#39;stream&#39;</span><span class="p">,</span>
                      <span class="n">half_basin</span><span class="o">=</span><span class="s1">&#39;half_basin&#39;</span><span class="p">,</span>
                      <span class="n">length_slope</span><span class="o">=</span><span class="s1">&#39;length_slope&#39;</span><span class="p">,</span>
                      <span class="n">slope_steepness</span><span class="o">=</span><span class="s1">&#39;slope_steepness&#39;</span><span class="p">,</span>
                      <span class="n">tci</span><span class="o">=</span><span class="s1">&#39;tci&#39;</span><span class="p">,</span>
                      <span class="n">spi</span><span class="o">=</span><span class="s1">&#39;spi&#39;</span><span class="p">,</span>
                      <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># List up created rasters</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">gcore</span><span class="o">.</span><span class="n">read_command</span><span class="p">(</span><span class="s1">&#39;g.list&#39;</span><span class="p">,</span>
                             <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;rast&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
accumulation
basin
dem
drainage
half_basin
length_slope
slope_steepness
spi
stream
tci

</pre></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">r.watarshed</span></code>コマンドのオプションは、今回QGISで実行したものと同じ値としました。各オプションの詳細は<a class="reference external" href="https://grass.osgeo.org/grass78/manuals/r.watershed.html">GRASS GISの公式ドキュメント</a>を参照してください。</p>
<p><code class="docutils literal notranslate"><span class="pre">r.watarshed</span></code>コマンドに続いて、<code class="docutils literal notranslate"><span class="pre">g.list</span></code>コマンドを実行し、作成したラスタデータの一覧を表示しています。</p>
<p><code class="docutils literal notranslate"><span class="pre">grass.script</span></code>の<code class="docutils literal notranslate"><span class="pre">core.run_command()</span></code>と<code class="docutils literal notranslate"><span class="pre">core.read_command()</span></code>との違いは、単純にGRASSのモジュールを動かす場合は<code class="docutils literal notranslate"><span class="pre">run_command()</span></code>、GRASSモジュールの標準出力を文字列でとってきたいときは<code class="docutils literal notranslate"><span class="pre">read_command()</span></code>を利用します。詳細は<a class="reference external" href="https://grasswiki.osgeo.org/wiki/GRASS_Python_Scripting_Library#Uses_for_read.2C_feed_and_pipe.2C_start_and_exec_commands">GRASS GISの公式wiki</a>に開設があります。</p>
<p>続いて、データベース内に生成されたラスタデータをGeotiffファイルとして抽出します。GRASSのデータベースからラスタデータをファイルとして取り出すには、<a class="reference external" href="https://grass.osgeo.org/grass78/manuals/r.out.gdal.html">r.out.gdalモジュール</a>を利用します。</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">gisdb</span><span class="o">=</span><span class="n">gisdb_path</span><span class="p">,</span>
             <span class="n">location</span><span class="o">=</span><span class="s1">&#39;fuefuki&#39;</span><span class="p">,</span>
             <span class="n">mapset</span><span class="o">=</span><span class="s1">&#39;PERMANENT&#39;</span><span class="p">):</span>
    <span class="n">gcore</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s1">&#39;r.out.gdal&#39;</span><span class="p">,</span>
                      <span class="n">flags</span><span class="o">=</span><span class="s1">&#39;mt&#39;</span><span class="p">,</span>
                      <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;accumulation&#39;</span><span class="p">,</span>
                      <span class="n">output</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;accumulation.tif&#39;</span><span class="p">),</span>
                      <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GTiff&#39;</span><span class="p">,</span>
                      <span class="n">createopt</span><span class="o">=</span><span class="s1">&#39;TFW=YES,COMPRESS=LZW&#39;</span><span class="p">,</span>
                      <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">accumuration</span></code>の所を、<code class="docutils literal notranslate"><span class="pre">basin</span></code>や<code class="docutils literal notranslate"><span class="pre">drainage</span></code>に変更することで、そのほかの生成されたラスタデータをファイルとして取り出すことができます。</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="comment_form.html" class="btn btn-neutral float-right" title="質問・コメント" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="leaf_area_index.html" class="btn btn-neutral float-left" title="OpenCVを利用した葉面積の推定" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; 著作権 2020, Taka

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>